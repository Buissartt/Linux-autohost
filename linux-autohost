#!/bin/bash

### GLOBAL VARIABLE ###
FILE_NAME=$0
DOCUMENT_ROOT=""
HOSTS_PATH=""
CREATE_DATABASE=0
OS=""
CURRENT_VERSION="1.0.2"
#######################

# Vérification que le script est lancé en root
if [ "$EUID" -ne 0 ]; then
	echo -e "\e[31mError \e[39m: You need to run this file using \e[33msudo\e[39m"
  	exit
fi

# Vérification que la distribution est debian based
if [[ $(cat /etc/*-release | grep ID=debian) = "" ]] && [[ $(cat /etc/*-release | grep ID_LIKE=debian) = "" ]] ;then
	echo -e "\e[31mError \e[39m: This script isn't accessible for non-debian based distribution."
  	exit
fi

# Vérification que apache2 est installé
if [[ $(dpkg --get-selections | grep apache2) = "" ]] ;then
	echo -e "\e[31mError \e[39m: You need to install \e[33mapache2\e[39m using \e[33msudo apt-get install apache2\e[39m."
  	exit
fi

# Vérication que mysql est installé
if [[ $(dpkg --get-selections | grep mysql-common) = "" ]] ;then
	echo -e "\e[31mError \e[39m: You need to install \e[33mmysql-common\e[39m using \e[33msudo apt-get install mysql-common\e[39m."
  	exit
fi

exec 6>&1 # Save default stdout to position 6

#Detect if it is a WSL or a native linux
if grep -q Microsoft /proc/version; then
	OS="Windows"
	HOSTS_PATH="/mnt/c/Windows/System32/drivers/etc/hosts"
else
	OS="Linux"
	HOSTS_PATH="/etc/hosts"
fi

########################################
# Help Commands

Help()
{
	RestoreStdOut
	echo -e "\e[32mUsage \e[39m: ${FILE_NAME} [OPTIONS]"
	echo -e ""
	echo -e "\e[32mExample \e[39m:"
	echo -e "  ${FILE_NAME} -p=/home/user/myproject -n=blog (On Linux and WSL)"
	echo -e "  ${FILE_NAME} -p=/mnt/d/Sites/myproject -n=blog (On WSL)"
	echo -e "  ${FILE_NAME} -r=blog (On Linux and WSL)"
	echo -e ""
	echo -e "\e[32mOptions \e[39m:"
	echo -e "  -n, --name    	\e[33m(Required)\e[39m The name of the new website you want to create."
	echo -e "  -p, --path    	\e[33m(Required)\e[39m The path of the source folder that contains source files."
	echo -e "  -d, --docroot 	\e[96m(Optional)\e[39m The path of the entry point directory within the project path"
	echo -e "  -r, --remove  	\e[96m(Optional)\e[39m Remove a configuration."
	echo -e "  -q, --quiet   	\e[96m(Optional)\e[39m Quiet mode. Nothing is written to standart output."
	echo -e "  -D, --database  	\e[96m(Optional)\e[39m Create a database by passing its name."
	echo -e "  -V, --version 	\e[96m(Optional)\e[39m Print the script version."
	echo -e "  -h, --help    	\e[96m(Optional)\e[39m Print the help message."
}

########################################


Version()
{
	RestoreForceStdOut
  	echo -e "\e[32mCurrent version : ${CURRENT_VERSION}\e[39m"
}

Main()
{

RestoreForceStdOut

if [[ -z $PROJECT_PATH ]]; then
	echo -e "\e[31mError \e[39m: Invalid arguments. You need to specify the project path."
	echo -e "For more informations, type \e[33m${FILE_NAME} -h\e[39m"
	exit
fi

QuietStdOut

# Create symoblic link
ln -s ${PROJECT_PATH} /var/www/${PROJECT_NAME}
if [ $? -eq 0 ]; then
	RestoreStdOut
	echo -e "\e[32mInfo \e[39m: \e[32m(/var/www/${PROJECT_NAME})\e[39m Symbolic link created"
else
	RestoreForceStdOut
	echo -e "\e[31mError \e[39m: Cannot create the symbolic link. Run the command \e[33msudo ${FILE_NAME} -r=${PROJECT_NAME}\e[39m then try again"
	exit
fi


# Write the new config file
cat >> /etc/apache2/sites-available/${PROJECT_NAME}.conf <<EOL
<VirtualHost *:80>
		ServerName www.${PROJECT_NAME}.local
		ServerAlias ${PROJECT_NAME}.local
		ServerAdmin webmaster@localhost
		DocumentRoot /var/www/${PROJECT_NAME}${DOCUMENT_ROOT}

		<Directory /var/www/>
				Options Indexes FollowSymLinks MultiViews
				AllowOverride all
				Order allow,deny
				Allow from all
		</Directory>

		ErrorLog /var/log/apache2/error.${PROJECT_NAME}.local.log
		CustomLog /var/log/apache2/error.${PROJECT_NAME}.local.log combined
</VirtualHost>
EOL
echo -e "\e[32mInfo \e[39m: \e[32m(/etc/apache2/sites-available/${PROJECT_NAME}.conf)\e[39m Configuration file created and updated"

# Enable the new conf file
echo -e "\e[32mInfo \e[39m: Enabling \e[32m/etc/apache2/sites-available/${PROJECT_NAME}.conf\e[39m file..."
QuietForceStdOut
a2ensite ${PROJECT_NAME}.conf
if [ $? -eq 0 ]; then
	RestoreStdOut
	echo -e "\e[32mInfo \e[39m: \e[32m/etc/apache2/sites-available/${PROJECT_NAME}.conf\e[39m enabled"
else
	RestoreForceStdOut
	echo -e "\e[31mError \e[39m: Cannot enable ${PROJECT_NAME}.conf file. Run the command \e[33msudo ${FILE_NAME} -r=${PROJECT_NAME}\e[39m then try again"
	exit
fi

#DNS
if [[ $OS = "Linux" ]]; then
cat >> ${HOSTS_PATH} <<EOL

## Autogenerated by Linux-autohost ##
::1       	www.${PROJECT_NAME}.local
127.0.0.1 	www.${PROJECT_NAME}.local
::1       	${PROJECT_NAME}.local
127.0.0.1 	${PROJECT_NAME}.local
#####################################
EOL
echo -e "\e[32mInfo \e[39m: ${HOSTS_PATH} updated"
else 
	RestoreForceStdOut
	echo ""
	echo -e "\e[33mImportant \e[39m: Host file can not be automatically modified, you'll need to update it manually."
	echo -e "Update it by adding the following lines to the \e[33mC:\Windows\System32\drivers\\etc\hosts\e[39m or directly on WSL on \e[33m${HOSTS_PATH}\e[39m :"
	echo "::1       www.${PROJECT_NAME}.local"
	echo "127.0.0.1 www.${PROJECT_NAME}.local"
	echo "::1       ${PROJECT_NAME}.local"
	echo "127.0.0.1 ${PROJECT_NAME}.local"
	echo ""
	QuietStdOut
fi

# Restart the apache's service
echo -e "\e[32mInfo \e[39m: Restarting apache2..."
QuietForceStdOut
service apache2 restart
if [ $? -eq 0 ]; then
	RestoreStdOut
	echo -e "\e[32mInfo \e[39m: Apache service successfully restarted"
else
	RestoreForceStdOut
	echo -e "\e[31mError \e[39m: Cannot restart apache service. Run the command \e[33msudo ${FILE_NAME} -r=${PROJECT_NAME}\e[39m then try again"
	exit
fi

echo ""


if [[ CREATE_DATABASE -eq 1 ]]; then
	RestoreForceStdOut
	read -p "Enter mysql username : " USERNAME
	while [ -z $USERNAME ]; do
		read -p "Enter mysql username : " USERNAME
	done

	read -p "Enter new database name : " DATABASE_NAME
	while [ -z $DATABASE_NAME ]; do
		read -p "Enter new database name : " DATABASE_NAME
	done
	
	service mysql start

	mysql -u $USERNAME -p -e "create database ${DATABASE_NAME}";
	if [ $? -eq 0 ]; then
		QuietStdOut
		echo -e "\e[32mInfo \e[39m: Database successfully created"
	else
		echo -e "\e[31mError \e[39m: Cannot create database. Run the command \e[33msudo ${FILE_NAME} -r=${PROJECT_NAME}\e[39m then try again"
		exit
	fi
fi


echo ""
echo "Now, check out the following url to access your new local website : http://${PROJECT_NAME}.local"

}

Verif()
{
	RestoreForceStdOut

	# Empty project name or path
	if [[ -z $PROJECT_NAME ]]; then
		echo -e "\e[31mError \e[39m: Invalid arguments. You need to specify the project name."
		echo -e "For more informations, type \e[33m${FILE_NAME} -h\e[39m"
		exit
	fi

	# Source path doesn't exist
	if [[ ! -e $PROJECT_PATH && -z $PROJECT_PATH ]]; then
		echo -e "\e[31mError \e[39m: Invalid arguments. ${PROJECT_PATH} does not exist."
		echo -e "For more informations, type \e[33m${FILE_NAME} -h\e[39m"
		exit
	fi

	# Source path isn't a directory
	if [[ ! -d $PROJECT_PATH ]]; then
		echo -e "\e[31mError \e[39m: Invalid arguments. ${PROJECT_PATH} is not a directory."
		echo -e "For more informations, type \e[33m${FILE_NAME} -h\e[39m"
		exit
	fi

	# Document root doesn't exist
	if [[ ! -d "${PROJECT_PATH}${DOCUMENT_ROOT}" || ! -e "${PROJECT_PATH}${DOCUMENT_ROOT}" ]]; then
		echo -e "\e[31mError \e[39m: Invalid arguments. ${PROJECT_PATH}${DOCUMENT_ROOT} is not valid entry directory"
		echo -e "For more informations, type \e[33m${FILE_NAME} -h\e[39m"
		exit
	fi

	# Symbolic link already exists
	if [[ -e /var/www/${PROJECT_NAME} ]]; then 
		echo -e "\e[31mError \e[39m: The directory or file /var/www/${PROJECT_NAME} already exists."
		echo -e "For more informations, type \e[33m${FILE_NAME} -h\e[39m"
		exit
	fi

	# Apache conf already exists
	if [[ -e /etc/apache2/sites-available/${PROJECT_NAME}.conf ]]; then 
		echo -e "\e[31mError \e[39m: The file /etc/apache2/sites-available/${PROJECT_NAME}.conf already exists."
		echo -e "For more informations, type \e[33m${FILE_NAME} -h\e[39m"
		exit
	fi
}

Remove()
{
	# Faire une vérification par y/n
	read -p "Important : Are you sure you want to remove the ${PROJECT_NAME} project ? (y/n) " answer
	compteur=0
	while ([ -z $answer ] || ([ $answer != "y" ] && [ $answer != "n" ] && [ $answer != "yes" ] && [ $answer != "no" ] && [ $answer != "Y"] && [ $answer != "N" ] )) && [ $compteur -lt 2 ]; do
		read -p "Important : Are you sure you want to remove the ${PROJECT_NAME} project ? (y/n) " answer
		let "compteur++"
	done

	if [ ! -z $answer ] && ([ $answer = "y" ] || [ $answer = "yes" ] || [ $answer = "Y" ]); then
		QuietStdOut

		# Supprimer les fichiers dans /var/www
		if [ -e /var/www/${PROJECT_NAME} ]; then
			rm -R /var/www/${PROJECT_NAME}
			if [ $? -eq 0 ]; then
				RestoreStdOut
				echo -e "\e[32mInfo \e[39m: Directory \e[32m(/var/www/${PROJECT_NAME})\e[39m deleted"
			else
				RestoreForceStdOut
				echo -e "\e[31mError \e[39m: Cannot delete \e[32m/var/www/${PROJECT_NAME}\e[39m. Try deleting it by yourself"
				exit
			fi	
			
		fi

		# Supprimer les fichiers dans sites-available et sites-enabled
		if [ -e /etc/apache2/sites-available/${PROJECT_NAME}.conf ]; then
			rm    /etc/apache2/sites-available/${PROJECT_NAME}.conf
			if [ $? -eq 0 ]; then
				RestoreStdOut
				echo -e "\e[32mInfo \e[39m: File \e[32m(/etc/apache2/sites-available/${PROJECT_NAME}.conf)\e[39m deleted"
			else
				RestoreForceStdOut
				echo -e "\e[31mError \e[39m: Cannot delete \e[32m/etc/apache2/sites-available/${PROJECT_NAME}.conf\e[39m. Try deleting it by yourself"
				exit
			fi	
			rm    /etc/apache2/sites-enabled/${PROJECT_NAME}.conf
			if [ $? -eq 0 ]; then
				RestoreStdOut
				echo -e "\e[32mInfo \e[39m: File \e[32m(/etc/apache2/sites-enabled/${PROJECT_NAME}.conf)\e[39m deleted"
			else
				RestoreForceStdOut
				echo -e "\e[31mError \e[39m: Cannot delete \e[32m/etc/apache2/sites-enabled/${PROJECT_NAME}.conf\e[39m. Try deleting it by yourself"
				exit
			fi	
		fi
		
		# Supprimer les fichiers de logs dans /var/log/apache2
		if [ -e /var/log/apache2/error.${PROJECT_NAME}.local.log ]; then
			rm    /var/log/apache2/error.${PROJECT_NAME}.local.log
			if [ $? -eq 0 ]; then
				RestoreStdOut
				echo -e "\e[32mInfo \e[39m: File \e[32m(/var/log/apache2/error.${PROJECT_NAME}.local.log)\e[39m deleted"
			else
				RestoreForceStdOut
				echo -e "\e[31mError \e[39m: Cannot delete \e[32m/var/log/apache2/error.${PROJECT_NAME}.local.log\e[39m. Try deleting it by yourself"
				exit
			fi	
		fi
			
		if [[ $OS = "Linux" ]]; then
			# Informations qu'il faut manuellement nettoyer le fichier hosts
			sed -i /"## Autogenerated by Linux-autohost ##"/d ${HOSTS_PATH}
			sed -i /"::1       	www.${PROJECT_NAME}.local"/d ${HOSTS_PATH}
			sed -i /"127.0.0.1 	www.${PROJECT_NAME}.local"/d ${HOSTS_PATH}
			sed -i /"::1       	${PROJECT_NAME}.local"/d ${HOSTS_PATH}
			sed -i /"127.0.0.1 	${PROJECT_NAME}.local"/d ${HOSTS_PATH}
			sed -i /"#####################################"/d ${HOSTS_PATH}
			if [ $? -eq 0 ]; then
				RestoreStdOut
				echo -e "\e[32mInfo \e[39m: File \e[32m(${HOSTS_PATH})\e[39m updated"
			else
				RestoreForceStdOut
				echo -e "\e[31mError \e[39m: Cannot update \e[32m${HOSTS_PATH}\e[39m. Try updating it by yourself"
				exit
			fi	
			echo -e "\e[32mInfo \e[39m: Hosts file updated"

		else
			RestoreForceStdOut
			echo ""
			echo -e "\e[33mImportant \e[39m: Host file can not be automatically modified, you'll need to update it manually."
			echo -e "Update it by removing the following lines to the \e[33mC:/Windows/System32/drivers/etc/hosts\e[39m or directly on WSL on \e[33m${HOSTS_PATH}\e[39m :"
			echo "::1       www.${PROJECT_NAME}.local"
			echo "127.0.0.1 www.${PROJECT_NAME}.local"
			echo "::1       ${PROJECT_NAME}.local"
			echo "127.0.0.1 ${PROJECT_NAME}.local"
			echo ""
			QuietStdOut
		fi

		# Reload le service apache2
		echo -e "\e[32mInfo \e[39m: Restarting apache2..."
		QuietForceStdOut
		service apache2 restart
		if [ $? -eq 0 ]; then
			RestoreStdOut
			echo -e "\e[32mInfo \e[39m: apache2 successfully restarted"
		else
			RestoreForceStdOut
			echo -e "\e[31mError \e[39m: Cannot restart apache service. Try doing it by yourself"
			exit
		fi	
		RestoreStdOut
		
	else
		exit
	fi

}

QuietStdOut()
{
	if [[ $IS_QUIET -eq 1 ]]; then
		exec > /dev/null # overwrite default stdout to /dev/null
	fi
}

QuietForceStdOut()
{
	exec > /dev/null # overwrite default stdout to /dev/null
}

RestoreStdOut()
{
	if [[ $IS_QUIET -ne 1 ]]; then
		exec 1>&6 # restore default stdout
	fi
}
RestoreForceStdOut()
{
	exec 1>&6 # restore default stdout
}

function join { local IFS="$1"; shift; echo "$*"; }


for arg in "$@"
do
	case $arg in
		-n=*|--name=*)
			PROJECT_NAME="${arg#*=}"
			shift
			shift
		;;
		-p=*|--path=*)
			PROJECT_PATH="${arg#*=}"
			# Split string by /
			PROJECT_PATH=$(echo $PROJECT_PATH | tr "/" "\n")
			# Join by /
			PROJECT_PATH=/$(join / ${PROJECT_PATH[@]})
			shift
			shift
		;;
		-d=*|--docroot=*)
			DOCUMENT_ROOT="${arg#*=}"
			if [[ -n $DOCUMENT_ROOT ]]; then
				# Split string by /
				DOCUMENT_ROOT=$(echo $DOCUMENT_ROOT | tr "/" "\n")
				# Join by /
				DOCUMENT_ROOT=/$(join / ${DOCUMENT_ROOT[@]})
			fi
		
			shift
			shift
		;;
		-D|--database) # Display nothing on the console
			CREATE_DATABASE=1
			shift
		;;
		-r=*|--remove=*)
			PROJECT_NAME="${arg#*=}"
			Remove
			shift
			shift
			exit
		;;
		-q|--quiet) # Display nothing on the console
			IS_QUIET=1
			QuietStdOut
			shift
		;;
		-h|--help) # display help
			Help
			exit
		;;
		-V|--version) # display version
			Version
			exit
		;;
	esac
done

Verif
Main
RestoreForceStdOut
exit
